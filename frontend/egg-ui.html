<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0c1c2a">
    <meta name="description" content="Transform your DNA sequence into unique, personalized music">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DNA Lifesong">

    <title>DNA Lifesong Studio</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ===== CSS Variables ===== */
        :root {
            --bg-dark: #0c1c2a;
            --text-primary: #c5dfe8;
            --text-secondary: #7a9eb0;
            --text-muted: #5a7e90;
            --accent-teal: #5fb3b3;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* ===== Login Overlay ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(8, 18, 28, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .login-overlay.hidden { display: none; }

        .login-box {
            background: rgba(12, 28, 42, 0.8);
            border: 1px solid rgba(100, 180, 200, 0.2);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 380px;
            width: 90%;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
        }

        .login-title {
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 3px;
            color: var(--text-primary);
            text-shadow: 0 0 20px rgba(95, 179, 179, 0.3);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .login-field { margin-bottom: 20px; }

        .login-input {
            width: 100%;
            background: rgba(8, 18, 32, 0.6);
            border: 1px solid rgba(100, 180, 200, 0.2);
            border-radius: 8px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            letter-spacing: 4px;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .login-input::placeholder {
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, rgba(74, 156, 164, 0.5) 0%, rgba(58, 124, 132, 0.5) 100%);
            border: 1px solid rgba(95, 179, 179, 0.4);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, rgba(90, 170, 178, 0.6) 0%, rgba(74, 140, 148, 0.6) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 156, 164, 0.3);
        }

        .login-error { color: #e85555; font-size: 0.85rem; margin-top: 16px; }
        .login-error.hidden { display: none; }

        /* Blur when not logged in */
        .egg-container.blurred {
            filter: blur(15px);
            pointer-events: none;
            user-select: none;
        }

        /* ===== Reset & Base ===== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* ===== Background ===== */
        .background {
            position: fixed;
            inset: 0;
            background: url('assets/1 Background new.png') no-repeat center center;
            background-size: cover;
            z-index: -1;
        }

        /* ===== Main Container ===== */
        .egg-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== Egg Frame ===== */
        .egg-frame {
            position: relative;
            width: min(88vw, 460px);
            height: min(125vw, 700px);
            background: url('assets/2 Egg Frame.png') no-repeat center center;
            background-size: contain;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10% 6% 6% 6%;
            gap: 2%;
        }

        /* ===== Section Labels ===== */
        .section-label {
            font-size: 0.7rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
            text-shadow: 0 1px 4px rgba(0,0,0,0.6);
            text-align: center;
            margin: 0;
        }

        /* ===== Top Button (Upload DNA) ===== */
        .btn-top {
            width: 65%;
            height: 50px;
            background: url('assets/top pill button.png') no-repeat center center;
            background-size: 100% 100%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-main);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            transition: transform 0.2s, filter 0.2s;
            flex-shrink: 0;
        }

        .btn-top:hover { transform: scale(1.03); filter: brightness(1.1); }
        .btn-top:active { transform: scale(0.97); }
        .btn-top:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== 3x4 Button Grid ===== */
        .button-grid {
            display: flex;
            gap: 4%;
            width: 92%;
            justify-content: center;
            flex-shrink: 0;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        /* Taper: each row narrower than the last */
        .button-row-0 { width: 100%; }
        .button-row-1 { width: 90%; margin: 0 auto; }

        .grid-btn {
            width: 100%;
            height: 42px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-main);
            font-size: 0.65rem;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            transition: transform 0.15s, filter 0.15s, border-color 0.15s, box-shadow 0.2s;
            text-align: center;
            padding: 4px 6px;
            -webkit-tap-highlight-color: transparent;
        }

        .grid-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
            border-color: rgba(255,255,255,0.4);
        }

        .grid-btn.selected {
            border-color: rgba(255,255,255,0.8);
            box-shadow: 0 0 12px rgba(255,255,255,0.3), inset 0 0 8px rgba(255,255,255,0.1);
            transform: scale(1.05);
            filter: brightness(1.25);
        }

        /* Red column colors (2 rows) */
        .col-red .grid-btn:nth-child(1) { background: rgba(190, 95, 80, 0.7); }
        .col-red .grid-btn:nth-child(2) { background: rgba(140, 60, 55, 0.65); }

        /* Green column colors */
        .col-green .grid-btn:nth-child(1) { background: rgba(100, 160, 100, 0.65); }
        .col-green .grid-btn:nth-child(2) { background: rgba(65, 115, 65, 0.6); }

        /* Blue column colors */
        .col-blue .grid-btn:nth-child(1) { background: rgba(90, 140, 190, 0.65); }
        .col-blue .grid-btn:nth-child(2) { background: rgba(55, 95, 135, 0.6); }

        /* ===== Bottom Section ===== */
        .bottom-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            width: 80%;
            flex-shrink: 0;
        }

        /* Create / Generate / Play Button (big teal pill) */
        .btn-create {
            width: 100%;
            height: 48px;
            background: linear-gradient(180deg, rgba(100, 200, 210, 0.4) 0%, rgba(60, 150, 180, 0.25) 100%);
            border: 1px solid rgba(130, 210, 220, 0.4);
            border-radius: 26px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.2s, filter 0.2s;
        }

        .btn-create:hover:not(:disabled) { transform: scale(1.03); filter: brightness(1.1); }
        .btn-create:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-create.cancel-state {
            background: linear-gradient(180deg, rgba(255,120,120,0.35) 0%, rgba(180,60,60,0.2) 100%);
            border-color: rgba(255,140,140,0.4);
        }

        .btn-create.play-state {
            background: linear-gradient(180deg, rgba(100,230,170,0.35) 0%, rgba(60,180,120,0.2) 100%);
            border-color: rgba(120,230,170,0.4);
        }

        /* Cancel button (smaller, darker) */
        .btn-cancel {
            width: 70%;
            height: 36px;
            background: linear-gradient(180deg, rgba(50, 80, 100, 0.4) 0%, rgba(30, 60, 80, 0.3) 100%);
            border: 1px solid rgba(100, 160, 180, 0.25);
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-main);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            transition: transform 0.2s, filter 0.2s, opacity 0.3s;
            opacity: 0.4;
        }

        .btn-cancel:hover:not(:disabled) { transform: scale(1.03); filter: brightness(1.1); }
        .btn-cancel:disabled { cursor: not-allowed; }
        .btn-cancel.active { opacity: 1; color: var(--text-primary); }

        /* Download button */
        .btn-download {
            width: 65%;
            height: 34px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: var(--font-main);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            transition: transform 0.2s, opacity 0.3s, color 0.2s;
            opacity: 0.3;
        }

        .btn-download:hover:not(:disabled) { transform: scale(1.03); color: var(--text-primary); }
        .btn-download:disabled { cursor: not-allowed; }
        .btn-download.ready { opacity: 1; color: var(--text-primary); }

        /* ===== Progress Ring (around egg) ===== */
        .progress-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(min(88vw, 460px) + 10px);
            height: calc(min(125vw, 700px) + 10px);
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .progress-ring.visible { opacity: 1; }

        .progress-ring svg {
            width: 100%;
            height: 100%;
        }

        /* ===== Status text ===== */
        .status-text {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            min-height: 16px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* ===== Toast Notifications ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(12, 28, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 180, 200, 0.3);
            border-radius: 8px;
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 0.85rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
            max-width: 320px;
        }

        .toast.success { border-color: #4eca8b; }
        .toast.error { border-color: #e85555; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none; }

        /* ===== Responsive ===== */
        @media (max-width: 380px) {
            .grid-btn {
                height: 36px;
                font-size: 0.58rem;
            }
            .btn-top { height: 42px; font-size: 0.85rem; }
            .btn-create { height: 42px; font-size: 0.9rem; }
        }

        @media (min-height: 850px) {
            .egg-frame {
                gap: 2.5%;
            }
            .grid-btn {
                height: 48px;
                font-size: 0.7rem;
            }
        }

        /* Tall phones */
        @media (min-height: 750px) and (max-width: 430px) {
            .egg-frame {
                height: min(135vw, 780px);
            }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h1 class="login-title">DNA LIFESONG STUDIO</h1>
            <p class="login-subtitle">Enter your access code to continue</p>
            <div class="login-field">
                <input type="password" id="loginCodeInput" class="login-input" placeholder="Access Code" autocomplete="off">
            </div>
            <button class="login-btn" id="loginBtn">Enter</button>
            <p id="loginError" class="login-error hidden">Invalid access code</p>
        </div>
    </div>

    <!-- Background -->
    <div class="background"></div>

    <!-- Main Container -->
    <div class="egg-container blurred" id="eggContainer">
        <div class="egg-frame">

            <!-- Top Button: Upload DNA → Generate → Play -->
            <button class="btn-top" id="btnTop">Upload DNA</button>

            <!-- Section Label -->
            <p class="section-label">Select Energy</p>

            <!-- 3x2 Button Grid (6 buttons - Mood + Vocal rows) -->
            <div class="button-grid">
                <!-- Red Column (left) -->
                <div class="button-column col-red">
                    <button class="grid-btn button-row-0" data-type="mood" data-value="meditative">Meditative</button>
                    <button class="grid-btn button-row-1" data-type="vocal" data-value="none">No Vocal</button>
                </div>

                <!-- Green Column (center) -->
                <div class="button-column col-green">
                    <button class="grid-btn button-row-0" data-type="mood" data-value="atmospheric">Atmospheric</button>
                    <button class="grid-btn button-row-1" data-type="vocal" data-value="female">Female</button>
                </div>

                <!-- Blue Column (right) -->
                <div class="button-column col-blue">
                    <button class="grid-btn button-row-0" data-type="mood" data-value="energetic">Energetic</button>
                    <button class="grid-btn button-row-1" data-type="vocal" data-value="male">Male</button>
                </div>
            </div>

            <!-- Bottom Section -->
            <div class="bottom-section">
                <button class="btn-create" id="btnCreate" disabled>Create</button>
                <button class="btn-cancel" id="btnCancel" disabled>Cancel</button>
                <button class="btn-download" id="btnDownload" disabled>&#8595; Download Song</button>
            </div>

            <!-- Status -->
            <p class="status-text" id="statusText"></p>

        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".txt,.fasta,.fa" class="hidden">

    <!-- JavaScript Modules -->
    <script src="js/dna-engine.js"></script>
    <script src="js/audio-player.js"></script>
    <script src="js/api-client.js"></script>
    <script>
        /**
         * DNA Lifesong Studio - Egg UI
         * Full app in egg visual design
         */
        const EggApp = {
            // State
            state: {
                phase: 'upload',        // 'upload', 'generate', 'play'
                mood: null,
                style: null,
                vocalType: null,
                dnaSequence: null,
                mp3Path: null,
                mp3Filename: null,
                coverPath: null,
                coverFilename: null,
                isGenerating: false,
                isCreatingCover: false,
                cancelRequested: false,
                coverReady: false
            },

            elements: {},

            // Password
            DEMO_PASSWORD: 'lifesong2026',

            init() {
                this.checkLogin();
                this.cacheElements();
                this.setupEventListeners();
                this.setupLoginListeners();
                this.initAudioPlayer();
                console.log('DNA Lifesong Egg UI initialized');
            },

            // ==================== LOGIN ====================

            checkLogin() {
                const loggedIn = sessionStorage.getItem('lifesong_logged_in');
                if (loggedIn === 'true') {
                    this.hideLoginOverlay();
                }
            },

            setupLoginListeners() {
                const loginBtn = document.getElementById('loginBtn');
                const loginInput = document.getElementById('loginCodeInput');
                const loginError = document.getElementById('loginError');

                if (loginBtn) {
                    loginBtn.addEventListener('click', () => this.attemptLogin());
                }
                if (loginInput) {
                    loginInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.attemptLogin();
                        if (loginError) loginError.classList.add('hidden');
                    });
                }
            },

            attemptLogin() {
                const loginInput = document.getElementById('loginCodeInput');
                const loginError = document.getElementById('loginError');
                const code = loginInput ? loginInput.value.trim() : '';

                if (!code) {
                    if (loginError) {
                        loginError.textContent = 'Please enter an access code';
                        loginError.classList.remove('hidden');
                    }
                    return;
                }

                if (code === this.DEMO_PASSWORD) {
                    sessionStorage.setItem('lifesong_logged_in', 'true');
                    this.hideLoginOverlay();
                    this.showToast('Welcome to DNA Lifesong Studio!', 'success');
                } else {
                    if (loginError) {
                        loginError.textContent = 'Invalid access code';
                        loginError.classList.remove('hidden');
                    }
                }
            },

            hideLoginOverlay() {
                const overlay = document.getElementById('loginOverlay');
                const eggContainer = document.getElementById('eggContainer');
                if (overlay) overlay.classList.add('hidden');
                if (eggContainer) eggContainer.classList.remove('blurred');
            },

            // ==================== INIT ====================

            cacheElements() {
                this.elements = {
                    btnTop: document.getElementById('btnTop'),
                    btnCreate: document.getElementById('btnCreate'),
                    btnCancel: document.getElementById('btnCancel'),
                    btnDownload: document.getElementById('btnDownload'),
                    gridBtns: document.querySelectorAll('.grid-btn'),
                    statusText: document.getElementById('statusText'),
                    toastContainer: document.getElementById('toastContainer'),
                    fileInput: document.getElementById('fileInput')
                };
            },

            setupEventListeners() {
                // Top button
                this.elements.btnTop.addEventListener('click', () => this.handleTopButton());

                // Grid buttons
                this.elements.gridBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.handleGridButton(btn));
                });

                // Bottom buttons
                this.elements.btnCreate.addEventListener('click', () => this.handleCreateButton());
                this.elements.btnCancel.addEventListener('click', () => this.handleCancelButton());
                this.elements.btnDownload.addEventListener('click', () => this.downloadSong());

                // File input
                this.elements.fileInput.addEventListener('change', (e) => this.onFileSelected(e));
            },

            initAudioPlayer() {
                AudioPlayer.init();
                AudioPlayer.setCallbacks({
                    onOriginalStateChange: (playing) => {
                        if (this.state.phase === 'play') {
                            this.elements.btnTop.textContent = playing ? 'Stop' : 'Play';
                        }
                    },
                    onCoverStateChange: (playing) => {
                        if (this.state.coverReady) {
                            this.elements.btnCreate.textContent = playing ? 'Stop' : 'Play Cover';
                        }
                    },
                    onError: () => {} // Suppress errors
                });
            },

            // ==================== TOP BUTTON ====================

            handleTopButton() {
                switch (this.state.phase) {
                    case 'upload':
                        this.uploadDNA();
                        break;
                    case 'generate':
                        this.generateMusic();
                        break;
                    case 'play':
                        AudioPlayer.toggleOriginal();
                        break;
                }
            },

            uploadDNA() {
                // Generate random DNA for now (can add file picker later)
                const length = Math.floor(Math.random() * 60 + 40) * 3;
                this.state.dnaSequence = DNAEngine.generateRealisticDNA(length);

                const analysis = DNAEngine.analyze(this.state.dnaSequence);
                this.setStatus(`${this.state.dnaSequence.length} bases | GC: ${analysis.gcFormatted}% | ${analysis.modeName}`);
                this.showToast(`Loaded ${this.state.dnaSequence.length} bases`, 'success');

                // Move to generate phase
                this.state.phase = 'generate';
                this.elements.btnTop.textContent = 'Generate';
            },

            async generateMusic() {
                if (!this.state.dnaSequence) {
                    this.showToast('No DNA loaded', 'error');
                    return;
                }

                AudioPlayer.stopAll();
                this.state.isGenerating = true;
                this.elements.btnTop.textContent = 'Generating...';
                this.elements.btnTop.disabled = true;
                this.setStatus('Generating your Lifesong...');

                try {
                    const result = await APIClient.generateMusic(this.state.dnaSequence, 45);

                    if (result.success) {
                        this.state.mp3Path = result.mp3_path;
                        this.state.mp3Filename = result.filename;
                        AudioPlayer.setOriginalFile(result.filename);

                        this.state.phase = 'play';
                        this.elements.btnTop.textContent = 'Play';
                        this.elements.btnCreate.disabled = false;

                        const a = result.analysis;
                        this.setStatus(`${a.key} ${a.mode} | ${a.tempo} BPM | ${a.codon_count} codons`);
                        this.showToast('Music generated!', 'success');
                    } else {
                        throw new Error(result.error || 'Generation failed');
                    }
                } catch (error) {
                    this.showToast(`Error: ${error.message}`, 'error');
                    this.elements.btnTop.textContent = 'Generate';
                    this.setStatus('');
                } finally {
                    this.state.isGenerating = false;
                    this.elements.btnTop.disabled = false;
                }
            },

            // ==================== GRID BUTTONS ====================

            handleGridButton(btn) {
                const type = btn.dataset.type;
                const value = btn.dataset.value;

                // Deselect others of same type
                this.elements.gridBtns.forEach(b => {
                    if (b.dataset.type === type) {
                        b.classList.remove('selected');
                    }
                });

                // Select this one
                btn.classList.add('selected');

                // Update state
                if (type === 'mood') this.state.mood = value;
                if (type === 'style') this.state.style = value;
                if (type === 'vocal') this.state.vocalType = value;
            },

            // ==================== CREATE / CANCEL ====================

            handleCreateButton() {
                if (this.state.coverReady) {
                    // Toggle play cover
                    AudioPlayer.toggleCover();
                } else {
                    this.createCover();
                }
            },

            handleCancelButton() {
                if (this.state.isCreatingCover) {
                    this.state.cancelRequested = true;
                    this.elements.btnCancel.textContent = 'Cancelling...';
                    this.setStatus('Cancelling...');
                }
            },

            async createCover() {
                if (!this.state.mp3Path) {
                    this.showToast('Generate music first!', 'error');
                    return;
                }

                this.state.isCreatingCover = true;
                this.state.cancelRequested = false;

                this.elements.btnCreate.disabled = true;
                this.elements.btnCreate.textContent = 'Creating...';
                this.elements.btnCreate.classList.add('cancel-state');
                this.elements.btnCancel.disabled = false;
                this.elements.btnCancel.classList.add('active');

                const prompt = this.buildPrompt();
                const tags = 'ambient, electronic, ethereal, dna, organic';

                try {
                    // Upload
                    this.setStatus('Uploading MP3...');
                    const uploadResult = await APIClient.uploadToMusicAPI(this.state.mp3Path);
                    if (!uploadResult.success) throw new Error(uploadResult.error);
                    if (this.state.cancelRequested) throw new Error('Cancelled');

                    // Create
                    this.setStatus('Creating AI cover...');
                    const createResult = await APIClient.createCover(uploadResult.clip_id, prompt, tags);
                    if (!createResult.success) throw new Error(createResult.error);
                    if (this.state.cancelRequested) throw new Error('Cancelled');

                    // Wait
                    this.setStatus('Waiting for AI (2-3 min)...');
                    const waitResult = await APIClient.waitForCover(
                        createResult.task_id,
                        (progress) => this.setStatus(`Processing... ${Math.round(progress)}%`),
                        () => this.state.cancelRequested
                    );

                    if (!waitResult.audio_url) throw new Error('No audio URL');

                    // Download
                    this.setStatus('Downloading cover...');
                    const downloadResult = await APIClient.downloadCover(waitResult.audio_url);
                    if (!downloadResult.success) throw new Error(downloadResult.error);

                    // Success!
                    this.state.coverPath = downloadResult.path;
                    this.state.coverFilename = downloadResult.filename;
                    this.state.coverReady = true;
                    AudioPlayer.setCoverFile(downloadResult.filename);

                    this.elements.btnCreate.textContent = 'Play Cover';
                    this.elements.btnCreate.classList.remove('cancel-state');
                    this.elements.btnCreate.classList.add('play-state');
                    this.elements.btnCreate.disabled = false;

                    this.elements.btnDownload.disabled = false;
                    this.elements.btnDownload.classList.add('ready');

                    this.setStatus('Cover ready!');
                    this.showToast('AI cover created!', 'success');

                } catch (error) {
                    if (error.message === 'Cancelled') {
                        this.setStatus('Cancelled');
                        this.showToast('Cancelled', 'info');
                    } else {
                        this.setStatus('Error: ' + error.message);
                        this.showToast(`Error: ${error.message}`, 'error');
                    }
                    this.elements.btnCreate.textContent = 'Create';
                    this.elements.btnCreate.classList.remove('cancel-state');
                    this.elements.btnCreate.disabled = false;
                } finally {
                    this.state.isCreatingCover = false;
                    this.elements.btnCancel.disabled = true;
                    this.elements.btnCancel.classList.remove('active');
                    this.elements.btnCancel.textContent = 'Cancel';
                }
            },

            // ==================== HELPERS ====================

            buildPrompt() {
                const moodTags = {
                    'meditative': '[meditative, ambient, atmospheric, slow tempo, no drums]',
                    'atmospheric': '[atmospheric, ambient, no drums, deep djembe, whale sounds, medium tempo]',
                    'energetic': '[atmospheric, ambient, upbeat tempo, edm, deep djembe, whale sounds]'
                };

                const styleTags = {
                    'electronic': '[electronic]',
                    'folk': '[indie folk]',
                    'classical': '[classical, orchestral, philharmonic]'
                };

                let prompt = '';
                if (this.state.style) prompt += styleTags[this.state.style] + ' ';
                if (this.state.mood) prompt += moodTags[this.state.mood] + ' ';

                if (this.state.vocalType === 'none' || !this.state.vocalType) {
                    prompt += '[instrumental, no vocals, no singing, no voice]';
                } else {
                    prompt += `[${this.state.vocalType} vocals, vocalise, wordless vocals]`;
                }

                return prompt;
            },

            onFileSelected(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const sequence = DNAEngine.parseFasta(content);
                    this.state.dnaSequence = sequence;

                    const analysis = DNAEngine.analyze(sequence);
                    this.setStatus(`${sequence.length} bases | GC: ${analysis.gcFormatted}%`);
                    this.showToast(`Loaded ${sequence.length} bases from ${file.name}`, 'success');

                    this.state.phase = 'generate';
                    this.elements.btnTop.textContent = 'Generate';
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            downloadSong() {
                const filename = this.state.coverFilename || this.state.mp3Filename;
                if (!filename) {
                    this.showToast('No song to download', 'error');
                    return;
                }

                const url = `/api/download-file/${encodeURIComponent(filename)}`;
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                this.showToast('Downloading...', 'success');
            },

            setStatus(text) {
                if (this.elements.statusText) {
                    this.elements.statusText.textContent = text;
                }
            },

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                this.elements.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // Initialize when DOM ready
        document.addEventListener('DOMContentLoaded', () => EggApp.init());
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
